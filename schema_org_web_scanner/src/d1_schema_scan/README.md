# Setup

## pyenv

    $ pyver=3.7.5
    $ pkg=/var/local/dataone/schema_org_scan
    
    $ sudo apt install libsqlite3-dev sqlite3
    $ CONFIGURE_OPTS="--enable-shared --enable-loadable-sqlite-extensions"
    $ pyenv install ${pyver}

    $ cd ${pkg}
    $ pyenv virtualenv ${pyver} schema_org_scanner_venv
    $ pyenv local schema_org_scanner_venv
    $ pyenv rehash
    $ echo ${pkg} >> `pyenv prefix`/lib/python3.7/site-packages/dataone.pth

    $ pip install --upgrade pip
    $ pip install channels channels_redis redis pyopenssl service_identity

# Configuration

    settings_deploy.py
    

# Django Admin

There's a simple administrative interface available, autogenerated by Django. 
 
    $ python manage.py createsuperuser

# Redis

## Deploy

    $ sudo apt update
    $ sudo apt install redis-server

Edit file

    $ sudo editor /etc/redis/redis.conf

Add or modify setting

    supervised systemd

## Dev

For development, this spins up Redis in a Docker container if one doesn't want to install it permanently as a service with `apt`.

    $ sudo apt install docker.io
    $ docker run -p 6379:6379 -d redis:2.8

# Creating a systemd service under Ubuntu

This will start the daphne WebSocket service and message handler worker processes automatically at boot. The service can be controlled from the shell via `systemctl`.

Set up the systemd unit files:

    $ cp ./deploy/*.service /etc/systemd/system
    
Modify the absolute paths in the unit files as required.

Enable the service with 10 workers and start it:

    $ systemctl enable dataone-schema-org-scanner.service
    $ systemctl enable dataone-schema-org-scanner-worker@{1..9}.service
    $ systemctl start dataone-schema-org-scanner.service

* The same number of workers will be started on reboot. The number of workers can be adjusted
  by enabling more workers using the same syntax or disabling existing ones with `systemctl disable`.

* `{1..9}` within the service string above causes the shell to expand the given string
  into a list of 10 strings where the number after `@` varies from 0 to 9. systemd then
  finds and reuses the worker `.service` template file, creating a service for each of
  the workers.
  
* All of the workers are started when the main service starts, as the main service
  has declared a dependency on all services matching the worker template.
```
