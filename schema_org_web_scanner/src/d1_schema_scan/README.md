# Setup

## pyenv

    $ pyver=3.7.5
    $ pkg=/var/local/dataone/schema_org_scan
    
    $ sudo apt install libsqlite3-dev sqlite3
    $ CONFIGURE_OPTS="--enable-shared --enable-loadable-sqlite-extensions"
    $ pyenv install ${pyver}

    $ cd ${pkg}
    $ pyenv virtualenv ${pyver} schema_org_scanner_venv
    $ pyenv local schema_org_scanner_venv
    $ pyenv rehash
    $ echo ${pkg} >> `pyenv prefix`/lib/python3.7/site-packages/dataone.pth

    $ pip install --upgrade pip
    $ pip install channels channels_redis redis pyopenssl service_identity

# Configuration

    settings_deploy.py
    

# Django Admin

There's a simple administrative interface available, autogenerated by Django. 
 
    $ python manage.py createsuperuser

# Redis

## Deploy

    $ sudo apt update
    $ sudo apt install redis-server

Edit file

    $ sudo editor /etc/redis/redis.conf

Add or modify setting

    supervised systemd

## Dev

For development, this spins up Redis in a Docker container if one doesn't want to install it permanently as a service with `apt`.

    $ sudo apt install docker.io
    $ docker run -p 6379:6379 -d redis:2.8

# Creating a systemd service under Ubuntu

This will start the daphne WebSocket service and message handler worker processes automatically at boot.  

Create file

    $ sudo editor /etc/systemd/system/dataone_schema_org_scanner.service

with contents:

```ini
[Unit]
Description=DataONE Schema.org Scanner
After=network.target
StartLimitIntervalSec=0

[Service]
Type=simple
Restart=always
RestartSec=1
User=gmn
ExecStart=/var/local/dataone/schema_org_scan/d1_schema_scan/start.sh

[Install]
WantedBy=multi-user.target
```

Adjust the ExecStart path.

Automatically start at boot:

    $ systemctl enable dataone_schema_org_scanner

Start:

    $ systemctl start dataone_schema_org_scanner
